<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>手勢熄滅蠟燭</title>
<style>
  body {
    display: flex;
    flex-direction: row;
    justify-content: center;
    align-items: flex-start;
    gap: 20px;
    font-family: Arial, sans-serif;
    margin: 20px;
  }
  video {
    border: 1px solid #ccc;
    border-radius: 8px;
    width: 320px;
    height: 240px;
  }
  #candle {
    position: relative;
    width: 120px;
    height: 300px;
    background: #c47b3f;
    border-radius: 20px 20px 8px 8px;
    box-shadow: inset 0 10px 20px #8b4d1a;
  }
  #flame {
    position: absolute;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    width: 40px;
    height: 80px;
    background: radial-gradient(circle at 50% 30%, #ffae00, #ff4500 60%, transparent 90%);
    border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
    animation: flicker 1s infinite alternate;
    opacity: 1;
    transition: opacity 0.8s ease;
  }
  @keyframes flicker {
    0%   { transform: translateX(-50%) scale(1) rotate(0deg); opacity: 1; }
    50%  { transform: translateX(-50%) scale(1.1) rotate(3deg); opacity: 0.9; }
    100% { transform: translateX(-50%) scale(1) rotate(-3deg); opacity: 1; }
  }
</style>
</head>
<body>

<video id="video" autoplay muted></video>

<div id="candle">
  <div id="flame"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core@4.7.0/dist/tf-core.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter@4.7.0/dist/tf-converter.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/handpose@0.0.7/dist/handpose.min.js"></script>

<script>
  const video = document.getElementById('video');
  const flame = document.getElementById('flame');

  // 蠟燭火焰的位置參考（相對於攝影機影像）
  // 手掌靠近這區域時，就會熄滅火焰
  // 這裡設成攝影機畫面中間偏上的位置
  const flameArea = {
    x: 160, // video width的一半
    y: 60,  // 蠟燭火焰相對應區域的Y座標
    radius: 80 // 影響範圍半徑
  };

  async function setupCamera() {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: {width: 320, height: 240},
      audio: false
    });
    video.srcObject = stream;

    return new Promise((resolve) => {
      video.onloadedmetadata = () => {
        resolve(video);
      };
    });
  }

  async function main() {
    await setupCamera();

    const model = await handpose.load();
    console.log("Handpose model loaded");

    // 持續偵測
    async function detect() {
      const predictions = await model.estimateHands(video, true);

      if (predictions.length > 0) {
        // 取第一隻手
        const hand = predictions[0];
        // 取手掌中心點 landmarks [0] 是手腕, [9]是手掌中間
        const palm = hand.landmarks[9];

        // 計算手掌中心與火焰區域的距離
        const dx = palm[0] - flameArea.x;
        const dy = palm[1] - flameArea.y;
        const dist = Math.sqrt(dx*dx + dy*dy);

        // console.log("Distance:", dist);

        if (dist < flameArea.radius) {
          // 靠近火焰，火焰漸漸熄滅
          flame.style.opacity = '0';
        } else {
          // 火焰恢復
          flame.style.opacity = '1';
        }
      } else {
        // 沒偵測到手，火焰保持點亮
        flame.style.opacity = '1';
      }

      requestAnimationFrame(detect);
    }

    detect();
  }

  main();
</script>

</body>
</html>
